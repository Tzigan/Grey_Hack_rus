using HarmonyLib;
using System;
using System.Reflection;

namespace GreyHackRussian.Patches
{
    [HarmonyPatch]
    public class ExploitDescriptionPatch
    {
        static MethodBase TargetMethod()
        {
            try
            {
                // Ищем тип Exploit по имени
                var exploitType = AccessTools.TypeByName("Exploit");
                if (exploitType != null)
                {
                    GreyHackRussianPlugin.Log.LogInfo($"Найден тип Exploit: {exploitType.FullName}");

                    // Ищем метод GenerateDescription
                    var method = AccessTools.Method(exploitType, "GenerateDescription");
                    if (method != null)
                    {
                        GreyHackRussianPlugin.Log.LogInfo($"Найден метод GenerateDescription");
                        return method;
                    }
                    else
                    {
                        GreyHackRussianPlugin.Log.LogWarning("Метод GenerateDescription не найден");
                    }
                }
                else
                {
                    GreyHackRussianPlugin.Log.LogWarning("Тип Exploit не найден");
                }
            }
            catch (Exception ex)
            {
                GreyHackRussianPlugin.Log.LogError($"Ошибка при поиске метода: {ex.Message}");
            }
            return null;
        }

        static void Postfix(object __instance)
        {
            try
            {
                // Получаем тип объекта __instance
                Type exploitType = __instance.GetType();
                GreyHackRussianPlugin.Log.LogDebug($"Вызван Postfix для объекта типа {exploitType.Name}");

                // Логируем доступные поля для отладки
                GreyHackRussianPlugin.Log.LogDebug("===== Доступные поля эксплойта =====");
                foreach (var field in exploitType.GetFields(BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Public))
                {
                    try
                    {
                        var value = field.GetValue(__instance);
                        GreyHackRussianPlugin.Log.LogDebug($"- {field.Name}: {(value != null ? value.ToString() : "null")}");
                    }
                    catch
                    {
                        GreyHackRussianPlugin.Log.LogDebug($"- {field.Name}: <не удалось получить значение>");
                    }
                }

                // Получаем текущее описание через рефлексию
                var descriptionField = exploitType.GetField("description",
                    BindingFlags.NonPublic | BindingFlags.Instance);

                if (descriptionField != null)
                {
                    GreyHackRussianPlugin.Log.LogDebug($"Найдено поле description в классе {exploitType.Name}");
                    string originalDescription = (string)descriptionField.GetValue(__instance);

                    GreyHackRussianPlugin.Log.LogDebug($"Оригинальное описание: \"{originalDescription}\"");

                    // Переводим описание
                    string translatedDescription = Translator.TranslateText(originalDescription);
                    GreyHackRussianPlugin.Log.LogDebug($"Результат перевода: \"{translatedDescription}\"");

                    if (originalDescription != translatedDescription)
                    {
                        // Устанавливаем переведённое описание
                        descriptionField.SetValue(__instance, translatedDescription);
                        GreyHackRussianPlugin.Log.LogInfo($"Описание эксплойта успешно переведено: \"{originalDescription}\" -> \"{translatedDescription}\"");
                    }
                    else
                    {
                        GreyHackRussianPlugin.Log.LogDebug("Перевод не требуется или не найден в словаре");

                        // Проверяем наличие подстрок для перевода
                        if (originalDescription.Length > 10)
                        {
                            // Проверяем первые 50 символов в словаре переводов
                            string checkPrefix = originalDescription.Substring(0, Math.Min(50, originalDescription.Length));
                            GreyHackRussianPlugin.Log.LogDebug($"Проверка первых 50 символов: \"{checkPrefix}\"");

                            foreach (var kvp in Translator.TranslationDictionary)
                            {
                                if (kvp.Key.StartsWith(checkPrefix) || originalDescription.StartsWith(kvp.Key))
                                {
                                    GreyHackRussianPlugin.Log.LogDebug($"Найдено похожее в словаре: \"{kvp.Key}\" -> \"{kvp.Value}\"");
                                }
                            }
                        }
                    }
                }
                else
                {
                    GreyHackRussianPlugin.Log.LogWarning("Не удалось найти поле description в классе Exploit");

                    // Логируем названия всех полей для поиска альтернатив
                    GreyHackRussianPlugin.Log.LogDebug("Доступные поля с текстом:");
                    foreach (var field in exploitType.GetFields(BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Public))
                    {
                        try
                        {
                            var value = field.GetValue(__instance);
                            if (value is string && !string.IsNullOrEmpty((string)value))
                            {
                                GreyHackRussianPlugin.Log.LogDebug($"- {field.Name}: {value}");
                            }
                        }
                        catch { }
                    }
                }
            }
            catch (Exception ex)
            {
                GreyHackRussianPlugin.Log.LogError($"Ошибка в ExploitPatch: {ex.Message}\n{ex.StackTrace}");
            }
        }
    }

    // Дополнительно патчим метод GetShopDescription для перевода в магазине
    [HarmonyPatch]
    public class ExploitGetShopDescriptionPatch
    {
        static MethodBase TargetMethod()
        {
            try
            {
                var exploitType = AccessTools.TypeByName("Exploit");
                if (exploitType != null)
                {
                    var method = AccessTools.Method(exploitType, "GetShopDescription");
                    if (method != null)
                    {
                        return method;
                    }
                }
            }
            catch (Exception ex)
            {
                GreyHackRussianPlugin.Log.LogError($"Ошибка при поиске метода: {ex.Message}");
            }
            return null;
        }

        static void Postfix(ref string __result)
        {
            if (!string.IsNullOrEmpty(__result))
            {
                __result = Translator.TranslateText(__result);
            }
        }
    }
}