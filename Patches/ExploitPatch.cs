using HarmonyLib;
using System;
using System.Reflection;
using System.Collections.Generic;

namespace GreyHackRussian.Patches
{
    /// <summary>
    /// Патч только для метода GetShopDescription, который отвечает за отображение описания эксплойта
    /// </summary>
    [HarmonyPatch(typeof(Exploit), "GetShopDescription")]
    public class ExploitPatch
    {
        // Словарь для кэширования переведенных описаний
        private static readonly Dictionary<string, string> translationCache = new Dictionary<string, string>();

        // Счетчик переведенных описаний
        private static int translatedCount = 0;

        static void Postfix(ref string __result)
        {
            try
            {
                // Проверка на пустую строку
                if (string.IsNullOrEmpty(__result))
                    return;

                string original = __result;

                // Проверяем, был ли этот текст уже переведен ранее
                if (translationCache.TryGetValue(original, out string cachedTranslation))
                {
                    __result = cachedTranslation;
                    GreyHackRussianPlugin.Log.LogInfo($"[Кэш] Использован кэшированный перевод описания ({translatedCount})");
                    return;
                }

                // Переводим текст
                string translated = Translator.TranslateText(original);

                // Если перевод отличается от оригинала, обновляем результат
                if (!original.Equals(translated))
                {
                    __result = translated;
                    translatedCount++;

                    // Добавляем в кэш для повторного использования
                    translationCache[original] = translated;

                    // Выводим информацию о переводе в лог (первые 100 символов)
                    int previewLength = Math.Min(100, original.Length);
                    string originalPreview = original.Substring(0, previewLength) + (original.Length > previewLength ? "..." : "");
                    string translatedPreview = translated.Substring(0, Math.Min(100, translated.Length)) + (translated.Length > previewLength ? "..." : "");

                    // Агрессивное логирование
                    GreyHackRussianPlugin.Log.LogInfo("=== ПЕРЕВОД ОПИСАНИЯ ЭКСПЛОЙТА ===");
                    GreyHackRussianPlugin.Log.LogInfo($"Перевод #{translatedCount}");
                    GreyHackRussianPlugin.Log.LogInfo($"ОРИГИНАЛ: {originalPreview}");
                    GreyHackRussianPlugin.Log.LogInfo($"ПЕРЕВОД: {translatedPreview}");
                    GreyHackRussianPlugin.Log.LogInfo("================================");
                }
                else
                {
                    // Вывод в лог информации о непереведенном тексте
                    GreyHackRussianPlugin.Log.LogInfo($"[!] Не найден перевод для описания ({original.Length} символов)");
                    GreyHackRussianPlugin.Log.LogDebug($"Текст без перевода: {original.Substring(0, Math.Min(100, original.Length))}...");

                    // Проверяем, есть ли похожие ключи в словаре переводов
                    if (original.Length > 10)
                    {
                        GreyHackRussianPlugin.Log.LogDebug("Проверка ключей перевода:");
                        foreach (var key in Translator.TranslationDictionary.Keys)
                        {
                            if (key.Contains(original.Substring(0, Math.Min(10, original.Length))) ||
                                original.Contains(key.Substring(0, Math.Min(10, key.Length))))
                            {
                                GreyHackRussianPlugin.Log.LogDebug($"Возможное соответствие: '{key}'");
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                GreyHackRussianPlugin.Log.LogError($"Ошибка при переводе описания: {ex.Message}");
                GreyHackRussianPlugin.Log.LogDebug($"Stack trace: {ex.StackTrace}");
            }
        }
    }
}